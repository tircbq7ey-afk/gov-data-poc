$y = @'
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: "${VERSION:-dev}"
        BUILD_TIME: "${BUILD_TIME:-unknown}"
        BUILD_SHA: "${BUILD_SHA:-unknown}"
    image: "${APP_IMAGE:-gov-data-poc-app}:${APP_TAG:-local}"
    environment:
      - API_TOKEN=${API_TOKEN:-}
      - VERSION=${VERSION:-dev}
      - BUILD_TIME=${BUILD_TIME:-unknown}
      - BUILD_SHA=${BUILD_SHA:-unknown}
    expose:
      - "8010"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8010/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  proxy:
    image: "nginx:1.27"
    depends_on:
      app:
        condition: service_healthy
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8080:80"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1/health"]
      interval: 20s
      timeout: 5s
      retries: 5
'@
Set-Content -LiteralPath "docker-compose.prod.yml" -Value $y -Encoding utf8 -NoNewline

# YAML 構文チェック（何も出なければOK）
docker compose -f docker-compose.prod.yml config > $null
