<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>gov-data-poc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#fafafa;--card:#fff;--text:#222;--muted:#666;--border:#e7e7e7;--accent:#2563eb}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;padding:24px;background:var(--bg);color:var(--text)}
    h1{font-size:22px;margin:0 0 16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="text"],input[type="number"]{height:36px;padding:0 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    input[type="file"]{border:1px dashed var(--border);padding:8px;border-radius:8px;background:#fff}
    button{height:36px;padding:0 14px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .answer{font-size:16px;line-height:1.7;white-space:pre-wrap}
    .grid{display:grid;gap:12px}
    .src{font-size:12px;margin-top:8px}
    .src a{color:#245;word-break:break-all}
    .kv{display:grid;grid-template-columns:130px 1fr;gap:8px}
    .sep{height:1px;background:var(--border);margin:12px 0}
    #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:8px;font-size:12px;opacity:0;pointer-events:none;transition:opacity .2s}
    #toast.show{opacity:.95}
  </style>
</head>
<body>
<h1>gov-data-poc</h1>

<!-- API キー -->
<div class="row" style="justify-content:flex-end;margin-bottom:8px">
  <span>API Key</span>
  <input id="apiKey" type="text" style="width:280px" placeholder="changeme-local-token" />
  <button id="saveKey">保存</button>
</div>

<!-- 質問欄 -->
<div class="row" style="margin-bottom:10px">
  <input id="q" type="text" style="flex:1;min-width:280px" placeholder="例) 就労ビザに必要な書類は？" />
  <button id="btnSearch">search</button>
  <button id="btnAsk" class="primary">ask</button>
</div>

<!-- パラメータ -->
<div class="row card muted" style="gap:16px">
  <div>top_k <input id="top_k" type="number" value="8" style="width:70px"></div>
  <div>min_score <input id="min_score" type="number" step="0.01" value="0" style="width:90px"></div>
  <div>bm25_top_n <input id="bm25_top_n" type="number" value="15" style="width:90px"></div>
  <div>w_bm25 <input id="w_bm25" type="number" step="0.01" value="0.9" style="width:90px"></div>
  <div>w_vec <input id="w_vec" type="number" step="0.01" value="0.85" style="width:90px"></div>
</div>

<!-- 回答とFB -->
<div class="card">
  <div class="muted" style="margin-bottom:6px">Answer</div>
  <div id="answer" class="answer"></div>
  <div class="row" style="margin-top:10px;gap:8px">
    <button id="btnGood" class="pill">👍 良かった</button>
    <button id="btnBad" class="pill">🔧 改善が必要</button>
    <span id="fbMsg" class="muted"></span>
  </div>
</div>

<!-- 検索結果 -->
<div id="results" class="grid"></div>

<!-- CSV バッチ -->
<div class="card" style="margin-top:20px">
  <div class="muted" style="margin-bottom:6px">CSV バッチ質問（POST /batch-ask）</div>
  <div class="kv muted">
    <div>説明</div><div>q 列を含む CSV を選び「実行」。完了すると answers.csv を自動ダウンロードします。</div>
  </div>
  <div class="sep"></div>
  <div class="row" style="margin-top:4px">
    <input id="csvFile" type="file" accept=".csv" />
    <button id="btnCsv" class="primary">実行</button>
  </div>
</div>

<div id="toast"></div>

<script>
/* ============ ユーティリティ ============ */
const $ = (id) => document.getElementById(id);
const toast = (msg) => { const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1600); };
const getToken = () => localStorage.getItem('apiKey') || 'changeme-local-token';
// 8080 で同一オリジン配下に API をプロキシしている想定
const base = () => '';

$('apiKey').value = getToken();
$('saveKey').onclick = () => {
  localStorage.setItem('apiKey', $('apiKey').value.trim());
  toast('API Key を保存しました');
};

function params () {
  const p = new URLSearchParams({
    top_k: $('top_k').value || '8',
    min_score: $('min_score').value || '0',
    bm25_top_n: $('bm25_top_n').value || '15',
    w_bm25: $('w_bm25').value || '0.9',
    w_vec: $('w_vec').value || '0.85',
  });
  return p.toString();
}

function setLoading(on) {
  $('btnSearch').disabled = on;
  $('btnAsk').disabled = on;
}

function showAnswer(text) { $('answer').textContent = text || ''; }

function showResults(items) {
  const box = $('results');
  box.innerHTML = '';
  (items || []).forEach((r) => {
    const div = document.createElement('div');
    div.className = 'card';
    const url = r.source_url || r.url || '';
    div.innerHTML = `
      <div class="muted">score=${(r.score ?? 0).toFixed(3)}</div>
      <div>${(r.text || '').replace(/\n/g,'<br>')}</div>
      <div class="src">source: ${url ? `<a href="${url}" target="_blank" rel="noreferrer noopener">${url}</a>` : '-'}</div>
    `;
    box.appendChild(div);
  });
}

async function callAPI(path) {
  const q = $('q').value.trim();
  if (!q) { toast('検索文を入力してください'); $('q').focus(); return; }
  setLoading(true);
  showAnswer('読み込み中...');
  try {
    const url = `${base()}${path}?q=${encodeURIComponent(q)}&${params()}`;
    const res = await fetch(url, { headers: { 'x-api-key': getToken() }});
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || data.ok === false) {
      console.error('API error:', data);
      showAnswer('エラーが発生しました。コンソールを確認してください。');
      return;
    }
    showAnswer(data.answer || '');
    showResults(data.results || data.sources || []);
  } catch (e) {
    console.error(e);
    showAnswer('通信に失敗しました。');
  } finally {
    setLoading(false);
  }
}

/* ============ ボタン ============ */
$('btnSearch').onclick = () => callAPI('/search');
$('btnAsk').onclick    = () => callAPI('/ask');

/* ============ フィードバック ============ */
async function sendFeedback(label) {
  const q = $('q').value.trim();
  const answer = $('answer').textContent || '';
  if (!q || !answer) { toast('まず質問して回答を表示してください'); return; }
  // 画面上の結果リンクを sources に詰める（配列）
  const sources = Array.from(document.querySelectorAll('#results .src a')).map(a => a.href);

  const payload = { q, answer, label, sources, lang: 'ja' };
  try {
    const res = await fetch(`${base()}/feedback`, {
      method: 'POST',
      headers: { 'x-api-key': getToken(), 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    });
    $('fbMsg').textContent = res.ok ? 'フィードバックを記録しました' : '送信に失敗しました';
    if (!res.ok) console.error('FB error', await res.text());
  } catch (e) {
    $('fbMsg').textContent = '送信に失敗しました';
    console.error(e);
  }
}
$('btnGood').onclick = () => sendFeedback('good');
$('btnBad').onclick  = () => sendFeedback('needs_improvement');

/* ============ CSV バッチ ============ */
$('btnCsv').onclick = async () => {
  const f = $('csvFile').files[0];
  if (!f) { toast('CSV ファイルを選択してください'); return; }
  const fd = new FormData();
  // サーバ側の引数名が file の想定
  fd.append('file', f, f.name);
  try {
    const res = await fetch(`${base()}/batch-ask?${params()}`, {
      method: 'POST',
      headers: { 'x-api-key': getToken() },
      body: fd
    });
    if (!res.ok) {
      const t = await res.text().catch(()=> '');
      alert(`アップロード失敗: ${res.status}\n${t}`);
      return;
    }
    // CSV を保存
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'answers.csv';
    document.body.appendChild(a); a.click(); a.remove();
    toast('answers.csv をダウンロードしました');
  } catch (e) {
    console.error(e);
    alert('通信エラーで失敗しました');
  }
};
</script>
</body>
</html>
